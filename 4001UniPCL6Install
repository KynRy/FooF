# Define the base URL
$baseUrl = "https://ftp.hp.com/pub/softlib/software13/printers/UPD/"

# Function to get the latest driver URL
function Get-LatestDriverUrl {
    param (
        [string]$baseUrl
    )
    try {
        # Get the HTML content of the base URL
        $htmlContent = Invoke-WebRequest -Uri $baseUrl

        # Parse the content to find the latest version
        $latestVersionUrl = $htmlContent.Links | Where-Object { $_.href -match "upd-pcl6-x64-.*\.exe" } | Sort-Object href -Descending | Select-Object -First 1 -ExpandProperty href
        if ($latestVersionUrl) {
            return "$baseUrl$latestVersionUrl"
        } else {
            Write-Warning "No driver executable found."
            return $null
        }
    } catch {
        Write-Error "Failed to retrieve the latest driver URL. Error: $_"
        return $null
    }
}

# Get the latest driver URL
$driverUrl = Get-LatestDriverUrl -baseUrl $baseUrl

if (-not $driverUrl) {
    exit
}

# Define paths
$downloadPath = "$env:TEMP\upd-pcl6-x64.exe"
$targetDirectory = "C:\drivers\printer\UniPCL6"
$zipFilePath = "$env:TEMP\upd-pcl6-x64.zip"

# Download the latest driver executable
Write-Host "Downloading driver from $driverUrl"
Invoke-WebRequest -Uri $driverUrl -OutFile $downloadPath

# Validate download
if (-not (Test-Path -Path $downloadPath)) {
    Write-Warning "The driver executable was not downloaded successfully."
    exit
